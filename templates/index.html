<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Device Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <!--style>
    :root {
      --primary: #6200ee;
      --primary-dark: #3700b3;
      --secondary: #03dac6;
      --background: #f4f4f4;
      --surface: #ffffff;
      --error: #b00020;
      --text: #000;
      --radius: 8px;
    }

    [data-theme="dark"] {
      --background: #121212;
      --surface: #1e1e1e;
      --text: #f0f0f0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--background);
      color: var(--text);
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    h1, h2 {
      color: var(--primary-dark);
    }

    #mqtt-status {
      font-weight: bold;
      padding: 8px 12px;
      border-radius: var(--radius);
      display: inline-block;
      margin-bottom: 16px;
      background-color: #eee;
    }

    form {
      background: var(--surface);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    form input, form button {
      padding: 10px;
      margin: 6px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: var(--radius);
    }

    form button {
      background: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    form button:hover {
      background: var(--primary-dark);
    }

    .device {
      background: var(--surface);
      border-left: 5px solid var(--primary);
      padding: 16px;
      margin-bottom: 15px;
      border-radius: var(--radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.5s ease;
    }

    .device-buttons button {
      margin-right: 10px;
      padding: 6px 12px;
      background-color: var(--secondary);
      color: #000;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
    }

    .device-buttons button:hover {
      background-color: #00c3aa;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s ease;
      z-index: 999;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      form input {
        font-size: 16px;
      }

      h1, h2 {
        font-size: 1.4em;
      }

      .device {
        font-size: 0.95em;
        padding: 12px;
      }

      .device-buttons button {
        padding: 5px 10px;
        font-size: 0.9em;
      }

      .toast {
        right: 10px;
        left: 10px;
        bottom: 20px;
        font-size: 0.95em;
      }
    }

    #theme-toggle {
      float: right;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--primary-dark);
    }

    body.dark {
      background: #121212;
      color: #e0e0e0;
    }

    body.dark form,
    body.dark .device {
      background-color: #1e1e1e;
      border-color: #333;
    }

    body.dark input, body.dark button {
      background-color: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
    }
  </style!-->
</head>
<body>

  <nav>
    <div class="menu-toggle" id="menu-toggle">&#9776;</div>
    <ul id="menu" class="menu">
      <li><a href="/">Αρχική</a></li>
      <li><a href="/mqtt">Ρυθμίσεις MQTT</a></li>
    </ul>
  </nav>

<!-- <div style="display: flex; justify-content: space-between; align-items: right;">
  <button id="theme-toggle">🌓 Dark Mode</button>
</div> -->

<div class="container">
  <h1>Devices</h1>
  <div id="mqtt-status">MQTT Status: Unknown</div>

  <h2>Προσθήκη Συσκευής</h2>
  <div id="edit-indicator" style="display:none; margin-bottom: 10px; font-weight: bold; color: var(--primary-dark);"></div>
  <form id="add-device-form">
    <input type="text" name="name" placeholder="Όνομα Συσκευής" required>
    <input type="number" name="pin_active" placeholder="Pin: Active" required>
    <input type="number" name="pin_enabled" placeholder="Pin: Enabled" required>
    <input type="number" name="pin_open" placeholder="Pin: Open" required>
    <input type="number" name="pin_enable" placeholder="Output Pin: Enable" required>
    <input type="number" name="pin_override" placeholder="Output Pin: Override" required>
    <button type="submit">➕ Προσθήκη</button>
  </form>

  <h2>Υφιστάμενες Συσκευές</h2>
  <div id="devices-container"></div>
</div>

<div id="toast" class="toast"></div>

<script>
  // Hamburger toggle
  const menuToggle = document.getElementById('menu-toggle');
  const menu = document.getElementById('menu');
  menuToggle.addEventListener('click', () => {
    menu.classList.toggle('show');
  });

  let allDevices = [];

  function getUsedPins() {
    const used = new Set();
    for (const d of allDevices) {
      Object.values(d.pins).forEach(pin => used.add(pin));
    }
    return used;
  }

  function showToast(message, success = true) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.backgroundColor = success ? '#28a745' : '#dc3545';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  async function fetchDevices() {
    const res = await fetch('/api/devices');
    const data = await res.json();
    allDevices = data;
    const container = document.getElementById('devices-container');
    container.innerHTML = '';

    data.forEach(device => {
      const p = device.pins;
      const div = document.createElement('div');
      div.className = 'device';
      div.innerHTML = `
        <strong>${device.name}</strong><br>
        Είσοδοι: Active=${p.active}, Enabled=${p.enabled}, Open=${p.open}<br>
        Έξοδοι: Enable=${p.enable}, Override=${p.override}
        <div class="device-buttons">
          <button onclick="editDevice('${device.id}')">✏️ Edit</button>
          <button onclick="deleteDevice('${device.id}')">🗑️ Διαγραφή</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  async function deleteDevice(id) {
    if (!confirm('Να διαγραφεί η συσκευή;')) return;
    const res = await fetch(`/api/devices/${id}`, { method: 'DELETE' });
    if (res.ok) {
      showToast("Διαγράφηκε.");
      fetchDevices();
    } else {
      showToast("Σφάλμα διαγραφής.", false);
    }
  }

  let editingDeviceId = null;

  function editDevice(id) {
    const device = allDevices.find(d => d.id === id);
    if (!device) return;

    setEditIndicator(device.name);
    const form = document.getElementById('add-device-form');
    form.name.value = device.name;
    form.pin_active.value = device.pins.active;
    form.pin_enabled.value = device.pins.enabled;
    form.pin_open.value = device.pins.open;
    form.pin_enable.value = device.pins.enable;
    form.pin_override.value = device.pins.override;

    editingDeviceId = id;
    form.querySelector('button[type="submit"]').textContent = 'Update Device';
  }


  document.getElementById('add-device-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = new FormData(this);
    const name = form.get('name');

    const pins = {
      active: +form.get('pin_active'),
      enabled: +form.get('pin_enabled'),
      open: +form.get('pin_open'),
      enable: +form.get('pin_enable'),
      override: +form.get('pin_override')
    };

    if (!name || Object.values(pins).some(v => isNaN(v))) {
      showToast("Συμπλήρωσε όλα τα πεδία σωστά.", false);
      return;
    }

    const device = {
      name,
      pins
    };

    let res;
    if (editingDeviceId) {
      res = await fetch(`/api/devices/${editingDeviceId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(device)
      });
    } else {
      const used = getUsedPins();
      const conflict = Object.values(pins).find(p => used.has(p));
      if (conflict) {
        showToast(`Το Pin ${conflict} χρησιμοποιείται ήδη.`, false);
        return;
      }

      res = await fetch('/api/devices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, pins })
      });
    }

    if (res.ok) {
      this.reset();
      showToast(editingDeviceId ? "Η συσκευή αποθηκεύθηκε!" : "Η συσκευή προστέθηκε!");
      editingDeviceId = null;
      setEditIndicator(null);
      fetchDevices();
    } else {
      const err = await res.text();
      showToast("Σφάλμα: " + err, false);
    }
  });

  async function checkMQTTStatus() {
    try {
      const response = await fetch('/api/mqtt/status');
      const data = await response.json();
      const statusDiv = document.getElementById('mqtt-status');
      statusDiv.textContent = 'MQTT Status: ' + (data.connected ? 'Connected' : 'Disconnected');
      statusDiv.style.color = data.connected ? 'green' : 'red';
    } catch {
      const s = document.getElementById('mqtt-status');
      s.textContent = 'MQTT Status: Error';
      s.style.color = 'gray';
    }
  }

  // document.getElementById('theme-toggle').addEventListener('click', () => {
  //   document.documentElement.toggleAttribute('data-theme', 'dark');
  // });

  fetchDevices();
  checkMQTTStatus();
  setInterval(checkMQTTStatus, 5000);

  // // Dark mode toggle
  // document.getElementById('theme-toggle').addEventListener('click', () => {
  //   document.body.classList.toggle('dark');
  //   localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  // });

  // Load theme on startup
  window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
    }
  });

  function setEditIndicator(deviceName) {
    const indicator = document.getElementById('edit-indicator');
    if (deviceName) {
      indicator.textContent = `Επεξεργάζεσαι τη συσκευή "${deviceName}"`;
      indicator.style.display = 'block';
    } else {
      indicator.style.display = 'none';
      indicator.textContent = '';
    }
  }

  // // Έλεγχος αν υπάρχει αποθηκευμένη προτίμηση
  // function applyDarkMode(enabled) {
  //   if (enabled) {
  //     document.body.classList.add('dark-mode');
  //     document.getElementById('dark-mode-toggle').textContent = 'Light Mode';
  //   } else {
  //     document.body.classList.remove('dark-mode');
  //     document.getElementById('dark-mode-toggle').textContent = 'Dark Mode';
  //   }
  //   localStorage.setItem('darkMode', enabled ? 'true' : 'false');
  // }

  // // Κατά το φόρτωμα της σελίδας
  // document.addEventListener('DOMContentLoaded', () => {
  //   const saved = localStorage.getItem('darkMode') === 'true';
  //   applyDarkMode(saved);

  //   document.getElementById('dark-mode-toggle').addEventListener('click', () => {
  //     const isDark = document.body.classList.contains('dark-mode');
  //     applyDarkMode(!isDark);
  //   });
  // });

</script>

</body>
</html>
