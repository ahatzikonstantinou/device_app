<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
  <meta charset="UTF-8">
  <title>{{ _('Device Manager') }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="{{ url_for('static', filename='menu.css') }}" />  
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />  
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script src="{{ url_for('static', filename='modal_mqtt.js') }}"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

  <nav>
    <div class="menu-header">
      <div class="left-group">
        <div class="menu-toggle" id="menu-toggle">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <div class="page-title">{{ _('Device Manager') }}</div>
      </div>
      <div id="mqtt-status">{{ _('MQTT Status: Unknown') }}</div>
    </div>

    <div class="menu-overlay" id="menu-overlay"></div>
    <ul id="menu" class="menu">
      <li><a href="/" class="active">{{ _('Αρχική') }}</a></li>
      <li><a href="/settings">{{ _('Ρυθμίσεις') }}</a></li>
    </ul>
  </nav>

<div class="container master-detail-container">
    <div class="master" role="region" aria-label="{{ _('Devices') }}" style="flex:1; min-width: 280px; padding-right:1rem; border-right: 1px solid #ddd;">
      <h1>{{ _('Devices') }}</h1>
      <div class="devices-header">
        <h2>Υπάρχουσες Συσκευές</h2>
        <button type="button" class="text-btn" onclick="addNewDevice()"><span class="material-symbols-outlined">add</span>{{ _("Προσθήκη Συσκευής") }}</button>
      </div>
      <div id="devices-container"></div>
    </div>

    <div class="detail" role="region" aria-label="{{ _('Φόρμα Συσκευής') }}" style="flex:2; min-width: 320px; padding-left:1rem;">
      <h2 id="form-title">{{ _('Προσθήκη Συσκευής') }}</h2>
      <div id="edit-indicator" style="display:none; margin-bottom: 10px; font-weight: bold; color: var(--primary-dark);"></div>
      <button type="button" id="backBtn" class="text-btn" style="margin-bottom: 1rem; display:none;"><span class="material-symbols-outlined">arrow_back</span>{{ _('Επιστροφή') }}</button>

      <form id="add-device-form">
        <input type="hidden" id="deviceId" name="id"/>
        <div class="form-group">
          <input type="text" id="deviceName" name="name" required placeholder=" " />
          <label for="deviceName">{{ _('Όνομα Συσκευής') }}</label>
        </div>

        <fieldset>
          <legend>GPIO Pins</legend>
          <div class="form-group note">{{ _('BCM mode — uses the Broadcom (SoC) GPIO numbers. Values are positive low i.e. a 1 means no signal in input, open relay at output. 0 means signal detected in input, close relay at output.') }}</div>

          <!--div class="form-group" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <input type="number" id="pin_powered" name="pin_powered" placeholder=" " />
            <label for="pin_powered">{{ _('Input Pin: Powered') }}</label>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div>

          <div class="form-group" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <input type="number" id="pin_active" name="pin_active" placeholder=" " />
            <label for="pin_active">{{ _('Input Pin: Active') }}</label>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div>

          <div class="form-group" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <input type="number" id="pin_enabled" name="pin_enabled" placeholder=" " />
            <label for="pin_enabled">{{ _('Input Pin: Enabled') }}</label>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div>

          <div class="form-group" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <input type="number" id="pin_closed" name="pin_closed" placeholder=" " />
            <label for="pin_closed">{{ _('Input Pin: Closed') }}</label>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div>

          <div class="form-group" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <input type="number" id="pin_overriden" name="pin_overriden" placeholder=" " />
            <label for="pin_overriden">{{ _('Input Pin: Overriden') }}</label>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div> -->

          <!-- div class="form-inline-pin" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <input type="number" id="pin_enable" name="pin_enable" placeholder=" " />
            <label for="pin_enable">{{ _('Output Pin: Enable') }}</label>
            <div class="radio-group">
              <label><input type="radio" name="pin_enable_value" value="0" /> 0</label>
              <label><input type="radio" name="pin_enable_value" value="1" /> 1</label>
            </div>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div>

          <<div class="form-inline-pin" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <input type="number" id="pin_override" name="pin_override" placeholder=" " />
            <label for="pin_override">{{ _('Output Pin: Override') }}</label>
            <div class="radio-group">
              <label><input type="radio" name="pin_override_value" value="0" /> 0</label>
              <label><input type="radio" name="pin_override_value" value="1" /> 1</label>
            </div>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div> -->

          <!-- <div class="form-inline-pin" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <div class="pin-content">
              <div class="pin-top-row">
                <div class="input-wrapper">
                  <input type="number" id="pin_enable" name="pin_enable" placeholder=" " />
                  <label for="pin_enable">{{ _('Output Pin: Enable') }}</label>
                </div>

                <div class="radio-group">
                  <label><input type="radio" name="pin_enable_value" value="0" /> 0</label>
                  <label><input type="radio" name="pin_enable_value" value="1" /> 1</label>
                </div>
              </div>

              <div class="pin-subscribe-row">
                <div class="input-wrapper">
                  <input type="text" id="mqtt_enable_topic" name="mqtt_enable_topic" placeholder=" " />
                  <label for="mqtt_enable_topic">{{ _('Subscribe Enable Topic') }}</label>
                </div>
              </div>
            </div>
            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div>

          <div class="form-inline-pin" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
            <div class="pin-content">
              <div class="pin-top-row">
                <div class="input-wrapper">
                  <input type="number" id="pin_override" name="pin_override" placeholder=" " />
                  <label for="pin_override">{{ _('Output Pin: Override') }}</label>
                </div>

                <div class="radio-group">
                  <label><input type="radio" name="pin_override_value" value="0" /> 0</label>
                  <label><input type="radio" name="pin_override_value" value="1" /> 1</label>
                </div>
              </div>

              <div class="pin-subscribe-row">
                <div class="input-wrapper">
                  <input type="text" id="mqtt_override_topic" name="mqtt_override_topic" placeholder=" " />
                  <label for="mqtt_override_topic">{{ _('Subscribe Override Topic') }}</label>
                </div>
              </div>
            </div>

            <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
          </div>           -->

          <div class="form-add-pin">
            <label for="new-pin-name" class="form-add-label">Add</label>
            
            <div class="add-pin-input-wrapper">
              <input type="text" id="new-pin-name" placeholder="Enter pin name" />
              <button type="button" class="clear-input" onclick="document.getElementById('new-pin-name').value = ''">✕</button>
            </div>
            
            <button type="button" class="add-pin-btn" onclick="addPin('in')">Input</button>
            <button type="button" class="add-pin-btn" onclick="addPin('out')">Output</button>
          </div>
        </fieldset>

        

        <fieldset>
          <legend>{{ _('MQTT') }}</legend>

          <div class="form-group">
            <input type="text" id="mqtt_pub_status" name="mqtt_pub_status" placeholder=" " />
            <label for="mqtt_pub_status">{{ _('Publish Status Topic') }}</label>
          </div>

          <!-- <div class="form-group">
            <input type="text" id="mqtt_enable" name="mqtt_enable" placeholder=" " />
            <label for="mqtt_enable">{{ _('Subscribe Enable Topic') }}</label>
          </div>

          <div class="form-group">
            <input type="text" id="mqtt_override" name="mqtt_override" placeholder=" " />
            <label for="mqtt_override">{{ _('Subscribe Override Topic') }}</label>
          </div> -->

          <div class="form-group">
            <input type="text" id="mqtt_sub_report_status" name="mqtt_sub_report_status" placeholder=" " />
            <label for="mqtt_sub_report_status">{{ _('Report Status Topic') }}</label>
          </div>
        </fieldset>

        <div style="text-align: right;">
          <button type="submit" class="text-btn">{{ _('Αποθήκευση') }}</button>
          <button id="form-close-btn" type="button" class="text-btn danger" onclick="closeAddDeviceModal()">{{ _('Κλείσιμο') }}</button>
          <button id="form-reret-btn" type="button" class="text-btn danger" onclick="resetAddDeviceModal()">{{ _('Επαναφορά') }}</button>
        </div>
      </form>
    </div>

</div>

<!-- Modal dialog to set Enable and Override pins-->
<div id="pin-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3 id="modal-title">{{ _('Set Pin Value') }}</h3>
    <p>{{ _('GPIO ID:') }} <span id="gpio-id"></span></p>
    <form id="pin-form">
      <label><input type="radio" name="pin-value" value="0" checked> 0</label>
      <label><input type="radio" name="pin-value" value="1"> 1</label>
    </form>
    <div id="response-msg" style="margin-top: 1rem;"></div>
    <div id="loader" class="loader" style="display: none;"></div>
    <div class="modal-buttons">
      <button id="set-pin-btn" class="text-btn" onclick="submitPinValue()" disabled>{{ _('Set') }}</button>
      <button class="text-btn" onclick="closePinModal()">{{ _('Κλείσιμο') }}</button>
    </div>
  </div>
</div>

<!-- Modal dialog to test send MQTT messages-->
<div id="mqtt-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3 id="mqtt-modal-title">{{ _('Αποστολή MQTT Μηνύματος') }}</h3>
    <p>Topic: <span id="mqtt-topic-display"></span></p>
    <textarea id="mqtt-payload" rows="4" style="width: 100%; margin-top: 1rem;">{}</textarea>
    <div id="mqtt-msg-response" style="margin-top: 1rem;"></div>
    <div class="modal-buttons">
      <button class="text-btn" onclick="sendMQTTMessage()">{{ _('Αποστολή') }}</button>
      <button class="text-btn" onclick="closeMQTTModal()">{{ _('Κλείσιμο') }}</button>
    </div>
  </div>
</div>


<div id="toast-container"></div>

<script>
  let allDevices = [];
  let expandedDeviceId = null;

  // code to add new pins
  function sanitizeToId(name) {
    return name
      .trim()
      .toLowerCase()
      .replace(/\s+/g, '_')            // Replace spaces with _
      .replace(/[^a-z0-9_]/g, '')      // Remove invalid characters
      .replace(/^([^a-z])/, '_$1');    // Ensure starts with a letter or underscore
  }

  function addPin(type, pinName = null, pin = null) {
    // console.log(`adding pin[${pinName}]: `, pin);
    const rawName = pinName ?? document.getElementById('new-pin-name').value.trim();
    if (!rawName) return alert("Please enter a pin name.");

    const id = sanitizeToId(rawName);
    if (!id) return alert("Invalid name for a pin.");

    // Avoid duplicates
    if (document.getElementById(`pin_${id}`) || document.getElementById(`mqtt_${id}`)) {
      return alert("Pin already exists.");
    }

    const label = rawName.charAt(0).toUpperCase() + rawName.slice(1);
    const pinValue = pin?.pin ?? '';
    const mqttValue = pin?.mqtt ?? '';
    const radioValue = pin?.value;
    let html = '';

    if (type === 'in') {
      html = `
        <div class="form-group" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
          <input type="number" id="pin_${id}" name="pin_${id}" placeholder=" " value="${pinValue}"/>
          <label for="pin_${id}">{{ _('Input Pin: ${label}') }}</label>
          <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
        </div>`;
    } else if (type === 'out') {
      html = `
        <div class="form-inline-pin" draggable="true" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
          <div class="pin-content">
            <div class="pin-top-row">
              <div class="input-wrapper">
                <input type="number" id="pin_${id}" name="pin_${id}" placeholder=" "  value="${pinValue}"/>
                <label for="pin_${id}">{{ _('Output Pin: ${label}') }}</label>
              </div>
              <div class="radio-group">
                <label><input type="radio" name="pin_${id}" value="0" ${radioValue === 0 ? 'checked' : ''}/> 0</label>
                <label><input type="radio" name="pin_${id}" value="1" ${radioValue === 1 ? 'checked' : ''} /> 1</label>
              </div>
            </div>
            <div class="pin-subscribe-row">
              <div class="input-wrapper">
                <input type="text" id="mqtt_${id}" name="mqtt_${id}" placeholder=" "  value="${mqttValue}"/>
                <label for="mqtt_${id}">{{ _('Subscribe ${label} Topic') }}</label>
              </div>
            </div>
          </div>
          <button type="button" class="delete-btn" onclick="removeFormGroup(this)">✕</button>
        </div>`;
    }

    const fieldset = document.querySelector('.form-add-pin');
    fieldset.insertAdjacentHTML('beforebegin', html);
    // console.log(`added html to fieldset`, html, fieldset);
    document.getElementById('new-pin-name').value = '';
  }
  // end of code to add new pins

  let isEditing = false; // ή true όταν μπαίνεις σε edit mode

  function removeFormGroup(button) {
    const container = button.closest('.form-group') || button.closest('.form-inline-pin');
    if (container) {
      container.remove();
    }
  }

  let draggedElement = null;

  function isDraggableBlock(el) {
    return el.classList.contains("form-group") || el.classList.contains("form-inline-pin");
  }

  function handleDragStart(e) {
    draggedElement = e.currentTarget;
    draggedElement.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  }

  function handleDragOver(e) {
    e.preventDefault();
    const target = e.currentTarget;
    if (target && target !== draggedElement && isDraggableBlock(target)) {
      const bounding = target.getBoundingClientRect();
      const offset = e.clientY - bounding.top;
      const midpoint = bounding.height / 2;

      const parent = target.parentNode;
      if (offset > midpoint) {
        parent.insertBefore(draggedElement, target.nextSibling);
      } else {
        parent.insertBefore(draggedElement, target);
      }
    }
  }

  function handleDrop(e) {
    e.preventDefault();
    if (draggedElement) {
      draggedElement.classList.remove("dragging");
      draggedElement = null;
    }
  }

  function getUsedPins() {
    const used = new Set();
    for (const d of allDevices) {
      Object.values(d.pins).forEach(pin => used.add(pin));
    }
    return used;
  }

  const socket = io({
    reconnection: true,
    reconnectionAttempts: 3,
    reconnectionDelay: 1000,
  });


  socket.on("pin_update", (update) => {
    const { device_id, pin_key, new_value } = update;

    const span = document.getElementById(`${device_id}-${pin_key}`);
    if (span) {
      const pin = span.textContent.split('(')[0].trim();
      span.textContent = `${pin} (${new_value})`;
    }
  });


  async function fetchDevices() {
    const res = await fetch('/api/devices');
    const data = await res.json();
    allDevices = data;

    // //test data
    // const id = "1";
    // const name = 'Πιεστικό σπιτιού';

    // const pins = {
    //   active: 
    //   {
    //     pin: 1,
    //     value: 1
    //   },
    //   enabled: 
    //   {
    //     pin: 2,
    //     value: 0
    //   },
    //   closed:  
    //   {
    //     pin: 3,
    //     value: 1
    //   },
    //   enable:  
    //   {
    //     pin: 4,
    //     value: 0
    //   },
    //   override:  
    //   {
    //     pin: 5,
    //     value: 1
    //   }
    // };

    // const mqtt = {
    //   status: '/alyki/piestiko/spiti/status',
    //   enable: '/alyki/piestiko/spiti/enable',
    //   override: '/alyki/piestiko/spiti/override',
    //   report_status: '/alyki/piestiko/spiti/report_status'
    // };

    // const device = {
    //   id,
    //   name,
    //   pins,
    //   mqtt
    // };

    // allDevices.push(device);

    const container = document.getElementById('devices-container');
    container.innerHTML = '';

    data.forEach(device => {
      const p = device.pins || {};
      const mqtt = device.mqtt || {};

      const card = document.createElement('div');
      card.className = 'device-card';

      // Helper to safely render input pins
      const renderStatusPins = (key, label) => {
        return p[key] ? `<div class="item">{{ _('${label}') }}<span id="${device.id}-${key}">${p[key].pin} (${p[key].value})</span></div>` : '';
      };

      // Helper to safely render control (output) pins
      const renderControlPin = (key, label) => {
        return p[key] ? `
          <div class="item">
            <button class="text-btn" onclick="openPinModal(${p[key].pin}, ${p[key].value}, '${label}')">{{ _('${label}') }}</button>
            <span id="${device.id}-${key}">${p[key].pin} (${p[key].value})</span>
          </div>
        ` : '';
      };

      // Render all status pins dynamically
      const renderInputPin = () => {
        return Object.entries(p)
          .filter(([key, pin]) => pin.type === 'in')
          .map(([key, pin]) =>
            `<div class="item">${key}: <span id="${device.id}-${key}">${pin.pin} (${pin.value})</span></div>`
          ).join('');
      };

      // Render all output pins dynamically with control buttons
      const renderOutputPins = () => {
        return Object.entries(p)
          .filter(([key, pin]) => pin.type === 'out')
          .map(([key, pin]) =>
            `<div class="item">
              <button class="text-btn" onclick="openPinModal(${pin.pin}, ${pin.value}, '${key}')">${key}</button>
              <span id="${device.id}-${key}">${pin.pin} (${pin.value})</span>
            </div>`
          ).join('');
      };

      card.innerHTML = `
        <div class="device-header" onclick="toggleCard(this)">
          <h3 class="device-title">${device.name}</h3>
          <span class="toggle-icon">▾</span>
        </div>

        <div class="device-details">
          <div class="device-section">
            <h4 class="section-title">{{ _('GPIO Pins') }}</h4>
            <p class="note">{{ _('BCM mode — uses the Broadcom (SoC) GPIO numbers. Values are positive low i.e. a 1 means no signal in input, open relay at output. 0 means signal detected in input, close relay at output') }}</p>
            <div class="group">
              <div class="pin-group">
                <h5>{{ _('Input Pins') }}</h5>
                ${renderInputPin()}
              </div>

              <div class="pin-group">
                <h5>{{ _('Control Pins') }}</h5>
                ${renderOutputPins()}
              </div>
            </div>
          </div>

          <hr>

          <div class="device-section">
            <h4 class="section-title">{{ _('MQTT') }}</h4>
            <div class="group mqtt">
              <div class="mqtt-group">
                <h5>{{ _('Publish Status Topic') }}</h5>
                <div class="item">{{ _('Status:') }} <span class="mqtt-topic" data-topic-type="status">${mqtt.pub_status || '-'}</span></div>
              </div>
              <div class="mqtt-group">
                <h5>{{ _('Subscribe Control Topics') }}</h5>
                <div class="item">{{ _('Report status:') }} <span class="mqtt-topic" data-topic-type="report_status">${mqtt.sub_report_status || '-'}</span></div>
                ${
                  Object.entries(p)
                    .filter(([_, pin]) => pin.type === 'out' && pin.mqtt)
                    .map(([key, pin]) => `
                      <div class="item">
                        {{ _('${key}:') }} <span class="mqtt-topic" data-topic-type="${key}">${pin.mqtt || '-'}</span>
                      </div>
                    `).join('') ||
                  `<div class="item">{{ _('No control topics') }}</div>`
                }
              </div>
            </div>
          </div>

          <div class="device-buttons">
            <button class="text-btn" onclick="editDevice('${device.id}')">{{ _('Επεξεργασία') }}</button>
            <button class="text-btn danger" onclick="deleteDevice('${device.id}')">{{ _('Διαγραφή') }}</button>
          </div>
        </div>
      `;

      container.appendChild(card);
    });


  }

  async function deleteDevice(id) {
    if (!confirm('{{ _("Να διαγραφεί η συσκευή;") }}')) return;
    const res = await fetch(`/api/devices/${id}`, { method: 'DELETE' });
    if (res.ok) {
      showToast("{{ _('Διαγράφηκε') }}.");
      editingDeviceId = null;
      exitEditMode();
      fetchDevices();
    } else {
      showToast("{{ _('Σφάλμα διαγραφής.') }}", 'error');
    }
  }

  let editingDeviceId = null;

  function editDevice(id) {
    resetAddDeviceModal();
    enterEditMode();
    document.getElementById('form-title').textContent = '{{ _("Επεξεργασία Συσκευής") }}';
    
    const device = allDevices.find(d => d.id === id);
    if (!device) return;

    setEditIndicator(device.name);

    const form = document.getElementById('add-device-form');

    const p = device.pins || {};
    const m = device.mqtt || {};

    form.id.value = device.id;
    form.name.value = device.name || '';

    // Dynamically create pins
    Object.entries(p).forEach(([key, pin]) => {
      // console.log('pin:', pin);
      addPin(pin.type, key, pin);
    });
    
    form.mqtt_pub_status.value = m.pub_status ?? '';
    form.mqtt_sub_report_status.value = m.sub_report_status ?? '';    

    editingDeviceId = id;
    form.querySelector('button[type="submit"]').textContent = '{{ _("Ενημέρωση") }}';
    document.body.classList.add('show-detail');
  }


  function addNewDevice() {
    resetAddDeviceModal();
    enterEditMode();
    editingDeviceId = null;
    const form = document.getElementById('add-device-form');
    form.querySelector('button[type="submit"]').textContent = '{{ _("Αποθήκευση") }}';
    document.body.classList.add('show-detail');

    // Καθάρισε τη φόρμα
    document.getElementById('add-device-form').reset();
    document.getElementById('form-title').textContent = '{{ _("Προσθήκη Συσκευής") }}';
    document.getElementById('edit-indicator').style.display = 'none';    
  }

  // Send a new device to the backend
  document.getElementById('add-device-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const formElement = this;
    const form = new FormData(this);
    const name = form.get('name');
    const id = form.get('id');

    function parsePin(value) {
      return value === null || value === '' ? null : (isNaN(value) ? NaN : Number(value));
    }

    const pins = {};
    const mqtt = {};
    
    function getSelectedRadioByName(name) {
      return document.querySelector(`input[type="radio"][name="${name}"]:checked`);
    }

    for (const element of formElement.elements) {
      if (!(element instanceof HTMLInputElement)) continue;

      const { id, type, value } = element;
      // console.log( 'element: ', element);

      if (!id || type === 'radio') {
        // console.log( 'it is a radio');
        continue; // Skip radio inputs entirely
      }
      if (id.startsWith('pin_')) {
        const baseName = id.replace(/^pin_/, '');
        const pinValue = parsePin(value);

        const selected = getSelectedRadioByName(id);
        if (selected){
          // It's an output pin
          pins[baseName] = {
            pin: pinValue,
            value: +selected.value,
            type: 'out'
          };
        } else {
          pins[baseName] = {
            pin: pinValue,
            type: 'in'
          };
        }
      }
    

      // console.log( 'pins:', pins);

      // Collect MQTT fields
      
      if (id.startsWith('mqtt_')) {
        const baseName = id.replace(/^mqtt_/, '');
        // Link to pin if baseName matches an existing pin
        if (pins.hasOwnProperty(baseName)) {
          pins[baseName].mqtt = value;
        }
        else {
          mqtt[baseName] = value;
        }
      }
      
      // console.log( 'mqtt > pins:', pins);
    }

    // console.log( 'pins:', pins);

    // Validation
    function isValidPin(pin) {
      // console.log('pin: ', pin);
      // console.log(typeof pin === 'number' && !isNaN(pin)? 'valid' : 'NOT valid');
      return typeof pin === 'number' && !isNaN(pin);
    }

    // Check for name overlap between input and output pins
    const allPinNames = Object.keys(pins).map(sanitizeToId);
    const uniquePinNames = new Set(allPinNames);
    if (uniquePinNames.size !== allPinNames.length) {
      showToast("{{ _('Κάθε pin πρέπει να έχει μοναδικό όνομα.') }}", 'error');
      return;
    }

    const pinValid = Object.values(pins).every(p => 
      isValidPin(p.pin) && 
      (p.value === undefined || isValidPin(p.value))
    );
    
    if (!name || !pinValid) {
      showToast("{{ _('Συμπλήρωσε όλα τα πεδία σωστά.') }}", 'error');
      return;
    }

    const device = {
      id,
      name,
      pins,
      mqtt
    };

    console.log(form, pins, mqtt, device);

    let res;
    if (editingDeviceId) {
      res = await fetch(`/api/devices/${editingDeviceId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(device)
      });
    } else {
      const used = getUsedPins();
      const conflict = Object.entries(pins).find(([name, pinObj]) => 
        used.has(pinObj.pin)
      );

      if (conflict) {
        const [conflictName, pinObj] = conflict;
        const msgTemplate = `{{ _('Το Pin %%\(conflict\)s χρησιμοποιείται ήδη.') }}`;
        const msg = msgTemplate.replace('%(conflict)s', conflictName);
        showToast(msg, 'error');
        return;
      }

      res = await fetch('/api/devices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(device)
      });
    }

    if (res.ok) {
      this.reset();
      showToast(editingDeviceId ? "{{ _('Η συσκευή αποθηκεύθηκε!') }}" : "{{ _('Η συσκευή προστέθηκε!') }}");
      editingDeviceId = null;
      setEditIndicator(null);
      fetchDevices();
      exitEditMode();
    } else {
      const err = await res.text();
      showToast("Σφάλμα: " + err, 'error');
    }
  });


  fetchDevices();
  checkMQTTStatus();
  setInterval(checkMQTTStatus, 5000);

  
  function toggleCard(el) {
    const card = el.closest('.device-card');
    if (!card.classList.contains('hide')) {
      card.classList.toggle('expanded');
    }
  }

  // // Dark mode toggle
  // document.getElementById('theme-toggle').addEventListener('click', () => {
  //   document.body.classList.toggle('dark');
  //   localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  // });

  // Load theme on startup
  window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
    }
  });

  function setEditIndicator(deviceName) {
    const indicator = document.getElementById('edit-indicator');
    if (deviceName) {
      const msgTemplate = `{{ _('Επεξεργάζεσαι τη συσκευή "%%\(deviceName\)s"') }}`;
      indicator.textContent = msgTemplate.replace('%(deviceName)s', deviceName);      
      indicator.style.display = 'block';
    } else {
      indicator.style.display = 'none';
      indicator.textContent = '';
    }
  }

  const masterPane = document.querySelector('.master');
  const detailPane = document.querySelector('.detail');
  const backBtn = document.getElementById('backBtn');

  // Αρχική κατάσταση: σε μικρή οθόνη μόνο master
  function updateLayout() {
    const isSmallScreen = window.innerWidth <= 768;
    const master = document.querySelector('.master');
    const detail = document.querySelector('.detail');

    if (isSmallScreen) {
      if (isEditing) {
        // Αν επεξεργάζεσαι, δείξε μόνο detail
        master.classList.add('hide');
        detail.classList.remove('hide');
        backBtn.style.display = 'inline-block';
      } else {
        // Αν ΔΕΝ επεξεργάζεσαι, δείξε μόνο master
        master.classList.remove('hide');
        detail.classList.add('hide');
        backBtn.style.display = 'none';
      }
    } else {
      // Σε μεγάλες οθόνες, δείχνεις και τα δύο πάντα
      master.classList.remove('hide');
      detail.classList.remove('hide');
    }
  }

  window.addEventListener('resize', updateLayout);

  function enterEditMode() {
    isEditing = true;
    updateLayout();
  }

  function exitEditMode() {
    isEditing = false;
    updateLayout();
  }
  updateLayout();
  
  document.getElementById('edit-indicator').textContent = '{{ _("Προσθήκη νέας συσκευής") }}';
  document.getElementById('edit-indicator').style.display = 'block';

  // Κουμπί επιστροφής
  backBtn.addEventListener('click', () => {
    exitEditMode();
  });

  function closeAddDeviceModal() {
    addNewDevice(); // reset the form
    exitEditMode();
  }

  function resetAddDeviceModal() {
    const form = document.getElementById('add-device-form');
    if (form) {
      const firstFieldset = form.querySelector('fieldset');
      if (firstFieldset) {
        firstFieldset.querySelectorAll('div.form-inline-pin, div.form-group').forEach(div => div.remove());
      }
    }
    exitEditMode();
  }

  function updateCloseButtonText() {
    const btn = document.getElementById('form-close-btn');
    if (!btn) return;
    
    if (window.innerWidth <= 768) {
      btn.textContent = 'Κλείσιμο';
    } else {
      btn.textContent = 'Καθάρισμα';
    }
  }

  // Εκτέλεση στην αρχή
  updateCloseButtonText();

  // Εκτέλεση όταν αλλάζει το μέγεθος του παραθύρου
  window.addEventListener('resize', updateCloseButtonText);

  // // Έλεγχος αν υπάρχει αποθηκευμένη προτίμηση
  // function applyDarkMode(enabled) {
  //   if (enabled) {
  //     document.body.classList.add('dark-mode');
  //     document.getElementById('dark-mode-toggle').textContent = 'Light Mode';
  //   } else {
  //     document.body.classList.remove('dark-mode');
  //     document.getElementById('dark-mode-toggle').textContent = 'Dark Mode';
  //   }
  //   localStorage.setItem('darkMode', enabled ? 'true' : 'false');
  // }

  // // Κατά το φόρτωμα της σελίδας
  // document.addEventListener('DOMContentLoaded', () => {
  //   const saved = localStorage.getItem('darkMode') === 'true';
  //   applyDarkMode(saved);

  //   document.getElementById('dark-mode-toggle').addEventListener('click', () => {
  //     const isDark = document.body.classList.contains('dark-mode');
  //     applyDarkMode(!isDark);
  //   });
  // });


</script>

  <script src="{{ url_for('static', filename='menu.js') }}"></script>
  <script src="{{ url_for('static', filename='toast.js') }}"></script>
  <script src="{{ url_for('static', filename='modal_pin_set.js') }}"></script>
</body>
</html>
